<?php/** * 1. 检查 IP 是否合法（预先定义可接受的 IP 地址） * 2. 获取发送号码，加密后内容，接收号码（POST） * 3. 根据接收号码读取key，根据发送号码读取银行短信内容正则 * 4. 根据key解密短信内容，正则匹配出：订单号（不可短信留言除外），对方账户名，收款卡末四位卡号，金额（建行含收款账户名） * 5. 写短信记录表（不包含在事务内） * ( 检查该订单是否已经处理过 ) * 6. 匹配充值记录表，成功则写帐变，更新用户余额，更新充值记录状态…… */error_reporting(E_ALL);function authcode($string, $operation = 'DECODE', $key = '', $expiry = 0) {	$ckey_length = 4;	$key = $key ? $key : '';	$key = md5($key);	$keya = md5(substr($key, 0, 16));	$keyb = md5(substr($key, 16, 16));	$keyc = $ckey_length ? ($operation == 'DECODE' ? substr($string, 0, $ckey_length): substr(md5(microtime()), -$ckey_length)) : '';	$cryptkey = $keya.md5($keya.$keyc);	$key_length = strlen($cryptkey);	$string = $operation == 'DECODE' ? base64_decode(substr($string, $ckey_length)) : sprintf('%010d', $expiry ? $expiry + time() : 0).substr(md5($string.$keyb), 0, 16).$string;	$string_length = strlen($string);	$result = '';	$box = range(0, 255);	$rndkey = array();	for($i = 0; $i < 256; $i++) {		$rndkey[$i] = ord($cryptkey[$i % $key_length]);	}	for($j = $i = 0; $i < 256; $i++) {		$j = ($j + $box[$i] + $rndkey[$i]) % 256;		$tmp = $box[$i];		$box[$i] = $box[$j];		$box[$j] = $tmp;	}	for($a = $j = $i = 0; $i < $string_length; $i++) {		$a = ($a + 1) % 256;		$j = ($j + $box[$a]) % 256;		$tmp = $box[$a];		$box[$a] = $box[$j];		$box[$j] = $tmp;		$result .= chr(ord($string[$i]) ^ ($box[($box[$a] + $box[$j]) % 256]));	}	if($operation == 'DECODE') {		if((substr($result, 0, 10) == 0 || substr($result, 0, 10) - time() > 0) && substr($result, 10, 16) == substr(md5(substr($result, 26).$keyb), 0, 16)) {			return substr($result, 26);		} else {			return '';		}	} else {		return $keyc.base64_encode($result);	}}// $key = 'suJVD5ncyoEMZuilzNVJrSXTnNtpBqq';// $sender = $_POST['sender'];// $number = $_POST['number'];// $sms = $_POST['content'];// // $sms_d = authcode($sms, 'DECODE', $key);// file_put_contents( './sms.txt' ,'[SENDER] '.$sender."\n".'[NUMBER] '.$number."\n".'[SMS_ORI] '.$sms."\n".'[SMS_DEC]'.$sms_d."\n".'[IP] '.$_SERVER['REMOTE_ADDR'], FILE_APPEND );$data_icbc="王大有已于4月4日向尾号为4112的工行账户汇入10000.98元。<王大有留言：110411102759888>。【工商银行】";$data_ccb="尊敬的岳志国客户：您好，赵朋丽已成功向您尾号为6866的账号转入人民币5000.00元，请注意查收。 留言为:110415144155143[建设银行]。";$data_abc="赵朋丽，您好。本行客户岳亮彬于2011年4月15日向您最后4位为5212的账号转入10.00元，特此提醒您进行核实。[中国农业银行]";$pattern_icbc = '/(?P<depositer>.*)已于.*(?P<numbertail>\d{4}).*汇入(?P<amount>.*)元。\<.*：(?P<order>\d+)\>.*/';$pattern_ccb = '/尊敬的(?P<account>.*)客户：您好，(?P<depositer>.*)已成功.*尾号为(?P<numbertail>\d{4}).*人民币(?P<amount>.*)元.*留言为:(?P<order>\d+)\[.*\]。/';$pattern_abc = '/(?P<account>.*)，您好。本行客户(?P<depositer>.*)于.*位为(?P<numbertail>\d{4}).*转入(?P<amount>.*)元.*/';//'(?P<deposit_name>\D+)\D{2}\d{1,2}\D{1}\d{1,2}\D{5}(?P<card_tail>\d{4})\D{7}(?P<amount>.*)\D{2}<\D+(?P<order_number>\d*)>\S+';//^\D{3}(?P<account_name>\D+)\D{2}'+u'\uff1a'+'\D{3}(?P<deposit_name>\D+)\D{8}(?P<card_tail>\d{4})\D{8}(?P<amount>\S+)\D{12}\:(?P<order_number>\d+)\[\D+\]\D+$if(preg_match($pattern_icbc,$data_icbc,$match_icbc)){	var_dump($match_icbc);}if(preg_match($pattern_ccb,$data_ccb,$match_ccb)){	var_dump($match_ccb);}if(preg_match($pattern_abc,$data_abc,$match_abc)){	var_dump($match_abc);}?>